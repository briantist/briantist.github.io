<!DOCTYPE html>
<html>
<head>
		<meta charset="utf-8">
	
	<title>Could not establish trust relationship for the SSL/TLS secure channel</title>
	
	
	<meta name="author" content="Brian Scholer">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="/assets/css/style.css" rel="stylesheet">
	<link href="/assets/css/slimbox2.css" rel="stylesheet">

	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->

	<link rel="alternate" type="application/rss+xml" title="" href="/feed.xml">
	
	<!-- Asynchronous Google Analytics snippet -->
	<script>
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-34696009-1', 'auto');
	ga('send', 'pageview');
	</script>
	<script async src='https://www.google-analytics.com/analytics.js'></script>
	
</head>

<body>
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="http://github.com/briantist">
				<i class="fa fa-github"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="http://twitter.com/BrianScholer">
				<i class="fa fa-twitter"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="mailto:brian@briantist.com">
				<i class="fa fa-envelope"></i>
			</a>
			
			<a class="navbar-brand" href="/">
				<img src="//www.gravatar.com/avatar/c54d4c111c4564b116ff1efca8c56788?s=35" class="img-circle" />
				briantist.com
			</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/"><i class="fa fa-home"></i>&nbsp;Home</a></li>
				
				
				
				
				<li><a href="/about-me/"><i class="fa fa-user"></i>&nbsp;About</a></li>
				
				
				
				<li><a href="/contact-me/"><i class="fa fa-envelope"></i>&nbsp;Contact</a></li>
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
			</ul>
		</div><!-- /.navbar-collapse -->
	</nav>

	<!-- nav-menu-dropdown -->
	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="/"><i class="fa fa-home"></i>Home</a></li>
			
			
			
			
			<li><a href="/about-me/"><i class="fa fa-user"></i>About</a></li>
			
			
			
			<li><a href="/contact-me/"><i class="fa fa-envelope"></i>Contact</a></li>
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			<li class="divider"></li>
			<li><a href="#"><i class="fa fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>

	<div class="col-sm-3 sidebar hidden-xs">
		<!-- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="/">
		<img src="//www.gravatar.com/avatar/c54d4c111c4564b116ff1efca8c56788?s=150" class="img-circle" />
	</a>
	<h3 class="title">
        <a href="/">briantist.com</a>
    </h3>
</header>



<div id="description" class="text-center">
	Four million lines of BASIC
</div>


<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="https://github.com/briantist">
				<i class="fa fa-github-alt fa-2x"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://twitter.com/BrianScholer">
				<i class="fa fa-twitter fa-2x"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="mailto:brian@briantist.com">
				<i class="fa fa-envelope fa-2x"></i>
			</a>
		</li>
		
	</ul>
	<ul id="contact-list-secondary" class="list-unstyled list-inline">
		
		
		<li>
			<a class="btn btn-default btn-sm" href="http://stackoverflow.com/users/3905079/briantist">
				<i class="fa fa-stack-overflow fa-2x"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://linkedin.com/in/bscholer">
				<i class="fa fa-linkedin fa-2x"></i>
			</a>
		</li>
		
		<li>
			<a class="btn btn-default btn-sm" href="/feed.xml">
				<i class="fa fa-rss fa-2x"></i>
			</a>
		</li>
	</ul>
	
	
</div>
<!-- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3">
		<div class="page-header">
  <h1>Could not establish trust relationship for the SSL/TLS secure channel </h1>
</div>
	
<article>

	<div class="col-sm-10">
		 <div class="byline">
		
			
		
		<time datetime="2015-08-17T18:40:33-04:00"><i class="fa fa-calendar"></i>
		August 17, 2015
		 </time>
		
		
		
		 <span class="comment-count"><i class="fa fa-comment"></i> <a data-disqus-identifier="4b360992-2ad8-47b6-a433-8b51b8b29c00" href="#disqus_thread">Comments</a></span>
	</div>
	
			 

	  <div class="article_body">
	  <p>Sometimes we run web services internally that don’t use a trusted SSL certificate. It’s not good practice, but in the real world this will be encountered.</p>

<p>In PowerShell, we often see this error come up when using <code class="highlight language-powershell" data-lang="powershell"><span class="nb">Invoke-WebRequest</span></code> or <code class="highlight language-powershell" data-lang="powershell"><span class="nb">Invoke-RestMethod</span></code> or even the <code class="highlight language-powershell" data-lang="powershell"><span class="no">[System.Net.WebClient]</span></code> class. All of these rely on the .Net framework which is set up to validate SSL certificates, so an exception gets thrown when we try to connect to a site over SSL that isn’t trusted.</p>

<p>For a while, a lot of people created a class that implemented the <code>ICertificatePolicy</code> interface, provided a method that always returned true, and then set <code class="highlight language-csharp" data-lang="csharp"><span class="n">System</span><span class="p">.</span><span class="n">Net</span><span class="p">.</span><span class="n">ServicePointManager</span><span class="p">.</span><span class="n">CertificatePolicy</span></code> to an instance of the new class. This is also the method I have used for a while, and in PowerShell it didn’t seem to complain. But I’ve recently found that <a href="http://stackoverflow.com/q/18454292/3905079" target="_blank" rel="nofollow">this method is in fact deprecated <i class="fa fa-stack-overflow"></i></a>.</p>

<p>It seems the correct way is to set the <code class="highlight language-csharp" data-lang="csharp"><span class="n">ServicePointManager</span><span class="p">.</span><span class="n">ServerCertificateValidationCallback</span></code> property to a callback function. Ok, no problem. It’s almost the same thing.
<a name="more"></a></p>

<h2 id="writing-a-module">Writing a Module</h2>

<p>I started to think about this more while writing a module that I planned to use internally, primarily against a web service that we run with an invalid certificate. But I didn’t like the idea of turning off SSL validation for the entire PowerShell session, which could affect other calls made by the scripts using the modules (without it being obvious that SSL validation was being skipped), so I sought a solution where I could set and unset the validation at will, and preserve whatever existing setting was in place.</p>

<p>The idea was to export module functions that include a switch parameter like <code>-SkipSslValidation</code> and the function could turn off validation, make its calls, then restore validation (or whatever the previous value was).</p>

<p>I started with <a href="http://stackoverflow.com/a/18454416/3905079" target="_blank">this answer from Dan Hunex <i class="fa fa-stack-overflow"></i></a>, which allows for the override, and modified it a bit so that it keeps track of the previous value and lets you restore it just as easily.</p>

<p>Here is the class definition in C#:</p>

<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
    <span class="k">using</span> <span class="nn">System.Net</span><span class="p">;</span>
    <span class="k">using</span> <span class="nn">System.Net.Security</span><span class="p">;</span>
    <span class="k">using</span> <span class="nn">System.Security.Cryptography.X509Certificates</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">SSLValidator</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">static</span> <span class="n">Stack</span> <span class="n">funcs</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Stack</span><span class="p">();</span>

        <span class="k">private</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">OnValidateCertificate</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">X509Certificate</span> <span class="n">certificate</span><span class="p">,</span> <span class="n">X509Chain</span> <span class="n">chain</span><span class="p">,</span>
                                                    <span class="n">SslPolicyErrors</span> <span class="n">sslPolicyErrors</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">OverrideValidation</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">funcs</span><span class="p">.</span><span class="n">Push</span><span class="p">(</span><span class="n">ServicePointManager</span><span class="p">.</span><span class="n">ServerCertificateValidationCallback</span><span class="p">);</span>
            <span class="n">ServicePointManager</span><span class="p">.</span><span class="n">ServerCertificateValidationCallback</span> <span class="p">=</span>
                <span class="n">OnValidateCertificate</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">RestoreValidation</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">funcs</span><span class="p">.</span><span class="n">Count</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">ServicePointManager</span><span class="p">.</span><span class="n">ServerCertificateValidationCallback</span> <span class="p">=</span> <span class="n">funcs</span><span class="p">.</span><span class="n">Pop</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span></code></pre></div>

<p>Now when you call <code class="highlight language-csharp" data-lang="csharp"><span class="n">OverrideValidation</span><span class="p">()</span></code> it stores the existing value in a stack. When you call <code class="highlight language-csharp" data-lang="csharp"><span class="n">RestoreValidation</span><span class="p">()</span></code> it simply pops the last value off the stack and sets the callback again. Using a stack makes it easier to nest calls in the client code without worrying about whether you’re restoring validation when a previous call expects it to be off.</p>

<h2 id="using-it-in-powershell">Using it in PowerShell</h2>

<p>Adding a C# class definition is very straightforward in PowerShell using the <a href="https://technet.microsoft.com/en-us/library/Hh849914.aspx" target="_blank"><code class="highlight language-powershell" data-lang="powershell"><span class="nb">Add-Type</span></code> cmdlet</a>, so in this example, <code class="highlight language-powershell" data-lang="powershell"><span class="nv">$definition</span></code> is a string consisting of the above code:</p>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nb">Add-Type</span> <span class="nv">$definiton</span></code></pre></div>

<p>To use the new object:</p>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nb">Invoke-WebRequest</span> <span class="n">https</span><span class="err">:</span><span class="p">//</span><span class="n">badsslhost</span> <span class="n">-UseBasicParsing</span> <span class="c"># fail</span>
<span class="no">[SSLValidator]</span><span class="p">::</span><span class="n">OverrideValidation</span><span class="p">()</span>
<span class="nb">Invoke-WebRequest</span> <span class="n">https</span><span class="err">:</span><span class="p">//</span><span class="n">badsslhost</span> <span class="n">-UseBasicParsing</span> <span class="c"># success</span>
<span class="no">[SSLValidator]</span><span class="p">::</span><span class="n">RestoreValidation</span><span class="p">()</span>
<span class="nb">Invoke-WebRequest</span> <span class="n">https</span><span class="err">:</span><span class="p">//</span><span class="n">badsslhost</span> <span class="n">-UseBasicParsing</span> <span class="c"># fail</span></code></pre></div>

<p>And in the context I was describing (a function):</p>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="k">function</span> <span class="nb">Get-SomeResource</span> <span class="p">{</span>
<span class="p">[</span><span class="k">CmdletBinding</span><span class="p">()]</span>
<span class="k">param</span><span class="p">(</span>
    <span class="no">[System.Uri]</span>
    <span class="nv">$Uri</span> <span class="p">,</span>

    <span class="no">[Switch]</span>
    <span class="nv">$IgnoreSslValidation</span>
<span class="p">)</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$IgnoreSslValidation</span><span class="p">)</span> <span class="p">{</span>
            <span class="no">[SSLValidator]</span><span class="p">::</span><span class="n">OverrideValidation</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="nb">Invoke-WebRequest</span> <span class="n">-Uri</span> <span class="nv">$Uri</span> <span class="n">-UseBasicParsing</span>

    <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$IgnoreSslValidation</span><span class="p">)</span> <span class="p">{</span>
            <span class="no">[SSLValidator]</span><span class="p">::</span><span class="n">RestoreValidation</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>


	  </div>
                    

		
		<ul class="list-inline">
		  <li><i class="fa fa-tags"></i></li>
		  
		  
			 
				<li>
					<a href="/tag/powershell/">
					powershell <span>(10)</span>
					
					</a>
				</li>
			
		  
		  
		</ul>
		  

		<hr>

		<div>
      <section class="share col-sm-6">
        <h4 class="section-title">Share Post</h4>
        <a class="btn btn-default btn-sm twitter" href="http://twitter.com/share?text=Could not establish trust relationship for the SSL/TLS secure channel&via=BrianScholer"
           onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
          <i class="fa fa-twitter fa-lg"></i>
          Twitter
        </a>
        <a class="btn btn-default btn-sm facebook" href="https://www.facebook.com/sharer/sharer.php"
           onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
          <i class="fa fa-facebook fa-lg"></i>
          Facebook
        </a>
        <a class="btn btn-default btn-sm gplus"
           onclick="window.open('https://plus.google.com/share?url='+window.location.href, 'google-plus-share', 'width=490,height=530');return false;">
          <i class="fa fa-google-plus fa-lg"></i>
          Google+
        </a>
      </section>

      
    </div>

    <div class="clearfix"></div>

		<ul class="pager">
		  
		  <li class="previous"><a href="/how-to/test-for-verbose-in-powershell/" title="Test for Verbose in Powershell">&larr; Previous</a></li>
		  
		  
			<li class="next disabled"><a>Next &rarr;</a>
		  
		</ul>

		<hr>
	</div>
	
	<div class="col-sm-2 sidebar-2">
	
	</div>
</article>
<div class="clearfix"></div>



    
<div id="disqus_thread"></div>


<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    var disqus_config = function () {
        this.page.url = 'https://www.briantist.com/errors/could-not-establish-trust-relationship-for-the-ssltls-secure-channel/';  /* Replace PAGE_URL with your page's canonical URL variable */
        this.page.identifier = '4b360992-2ad8-47b6-a433-8b51b8b29c00'; /* Replace PAGE_IDENTIFIER with your page's unique identifier variable */
    };
    (function() {  /* DON'T EDIT BELOW THIS LINE */
        var d = document, s = d.createElement('script');
        
        s.src = '//briantist.disqus.com/embed.js';
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

 <script id="dsq-count-scr" src="//briantist.disqus.com/count.js" async></script>





		<footer>
			<hr/>
			<p>
				&copy; 2012 &ndash; 2015 Brian Scholer &nbsp;&middot;&nbsp; <a rel="nofollow" target="_blank" href="https://cloudflare.ipv6-test.com/validate.php?url=www.briantist.com"><img src="https://ajax.cloudflare.com/cdn-cgi/custom/images/button-ipv6-80x15.png" alt="ipv6 ready" title="ipv6 ready" border="0" style="vertical-align: middle;" width="80" height="15" /></a>
			</p>
		</footer>
	</div>

	<script type="text/javascript" src="/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="/assets/resources/slimbox2/slimbox2.js"></script>
	<script type="text/javascript" src="/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	
</body>
</html>
